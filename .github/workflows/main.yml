name: Build and Deploy to Kubernetes

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  DOCKER_REGISTRY: swr.ap-southeast-2.myhuaweicloud.com
  DOCKER_NAMESPACE: live/ghulammuzzmit
  IMAGE_NAME: scrapper

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get short commit hash
        id: vars
        run: echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Huawei SWR
        run: |
          docker login -u ap-southeast-2@${{ secrets.HUAWEI_SWR_ACCESS_ID }} \
            -p ${{ secrets.HUAWEI_SWR_PASSWORD }} \
            swr.ap-southeast-2.myhuaweicloud.com

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.SHORT_SHA }}
            ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Update image tag in Kubernetes manifests
        run: |
          NEW_IMAGE="${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.SHORT_SHA }}"
          
          # Update app.yaml
          sed -i "s|image: swr.ap-southeast-2.myhuaweicloud.com/live/ghulammuzzmit/scrapper:.*|image: ${NEW_IMAGE}|g" .k8s/app/app.yaml
          
          echo "Updated image tag to: ${NEW_IMAGE}"
          cat .k8s/app/app.yaml | grep "image:"

      - name: Deploy to Kubernetes
        run: |
          echo "Deploying application..."
          kubectl apply -f .k8s/app/
          
          echo "Deploying virtual service..."
          kubectl apply -f .k8s/vs/
          
          echo "Waiting for rollout to complete..."
          kubectl rollout status deployment/scrapper-app -n test --timeout=5m
          
          echo "Deployment completed successfully!"

      - name: Verify deployment
        run: |
          echo "Current deployment status:"
          kubectl get deployment scrapper-app -n test
          kubectl get pods -n test -l app=scrapper-app
